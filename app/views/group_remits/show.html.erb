<%= turbo_stream_from current_cooperative, "batches" %>

<div class="mb-3 d-flex gap-3 align-items-center">
  <%= link_to 'MOAs', agreements_path, class: 'btn btn-sm btn-secondary' %>
  <% unless @group_remit.submitted? %>
    <div class="d-flex gap-1">
      <% unless @batch_without_beneficiaries_count > 0 || @batch_without_batch_health_dec_count > 0 || @batch_count < @agreement.proposal.minimum_participation %>
        <%= link_to 'Submit Remittance', submit_group_remit_path(@group_remit),class: 'btn btn-sm btn-warning', data: {turbo: false, confirm: 'Delete group remit?' } %>
      <% end %>
      <%= button_to "Delete", group_remit_path(@group_remit), 
          method: :delete,
          form: { 
          data: { turbo: false},
          confirm: "Delete this group remit?"
          }, 
          class: 'btn btn-sm btn-danger' %>
    </div>
  <% end %>
</div>
<div class="d-flex align-items-center gap-1 mb-3">
  <%= content_tag :span, "#{@group_remit.submitted ? 'Active' : 'New'}", style: "color: #{@group_remit.submitted ? '#ffc107' : 'green'}; font-weight: 700;" %>
  <%= content_tag :h3, "#{@agreement.moa_no}", class: 'mb-0' %>
</div>

<div class="d-flex justify-content-between align-items-center mb-3 gap-3">
  <div class="d-flex flex-column " style="height: 100%; width: 100%">
    <div class="d-flex justify-content-between mb-2" style="height: 100%; width: 460px;">
      <div style="width: 100%">
        <% unless @group_remit.submitted? %>
            <%= turbo_frame_tag "batch_import_form" do %>
              <%= turbo_frame_tag "batch_form" do %>     
                <div class="d-flex gap-3 mb-2">
                  <%= render 'group_remits/add_member' %>
                </div>
                <% if @batch_without_beneficiaries_count > 0 || @batch_without_batch_health_dec_count > 0 || @batch_count < @agreement.proposal.minimum_participation %>
                  <div class="d-flex flex-column">
                    <%= content_tag :span, "Unable to submit group remit due to: ", class: 'mb-1',  style: "font-size: .7rem; color: red !important; font-weight: 700;"  %>
                    <div class="">
                      <% if @batch_count < @agreement.proposal.minimum_participation %>
                        <%= content_tag :span, "Below minimum participation: Need #{@agreement.proposal.minimum_participation - @batch_count} more", class: 'badge bg-danger' %>
                      <% end %>
                      <% if @batch_without_beneficiaries_count > 0 %>
                        <%= content_tag :span, "#{@batch_without_beneficiaries_count} member(s) without beneficiary!", class: 'badge bg-danger' %>
                      <% end %>
                      <% if @batch_without_batch_health_dec_count > 0 %>
                        <%= content_tag :span, "#{@batch_without_batch_health_dec_count} member(s) without batch health declaration!", class: 'badge bg-danger' %>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              <% end %>
            <% end %>
        <% end%>
      </div>
    </div>

    <div class="card">
      <div class="card-body text-secondary">
        <div class="d-flex justify-content-center">
          <%= content_tag :h6, "Effectivity Date ", style: "width: 150px; font-size: .8rem" %>
          <%= content_tag :h6, "#{@group_remit.effectivity_date.present? ? @group_remit.effectivity_date.strftime('%B %d, %Y') : 'Tentative'}", style: "width: 150px; font-size: .8rem" %>
        </div>
        <div class="d-flex justify-content-center">
          <%= content_tag :h6, "Expiry Date", style: "width: 150px; font-size: .8rem" %>
          <%= content_tag :h6, "#{@group_remit.expiry_date.strftime('%B %d, %Y')}", style: "width: 150px; font-size: .8rem" %>
        </div>
        <div class="d-flex justify-content-center">
          <%= content_tag :h6, "Terms", style: "width: 150px; font-size: .8rem" %>
          <%= content_tag :h6, "#{@group_remit.terms}", style: "width: 150px; font-size: .8rem"%>
        </div>
      </div>
    </div>
  </div>

  <div class="card" style="height: 100%; width: 100%">
    <div class="card-body d-flex flex-column justify-content-around">
      <div class="d-flex justify-content-center">
        <%= content_tag :h6, "#{@agreement.plan.name}"%>
      </div>
      <div class="d-flex justify-content-between align-items-center">
        <%= content_tag :h6, "Insured", style: "width: 150px;" %>
        <%= content_tag :h6, "Benefit", style: "width: 150px;", class: 'text-center' %>
        <%= content_tag :h6, "Coverage Amount", style: "width: 150px;", class: 'text-center'%>
      </div>
      <% @agreement.agreement_benefits.each do |ab| %>
        <div class="d-flex justify-content-between align-items-center text-secondary">
          <%= content_tag :span, "#{ab.insured_type == 'principal' ? ab.insured_type.upcase : ab.insured_type.gsub('_', ' ').split(' ').drop(1).join(' ').upcase}", class: 'text-secondary', style: 'font-size: .8rem' %>
          <div class="d-flex flex-column justify-content-between align-items-center">
            <% ab.product_benefits.each do |product| %>
              <div class="d-flex justify-content-around text-secondary mb-1">
                <%= content_tag :span, "#{product.benefit.name}", style: "width: 150px; font-size: .8rem", class: 'text-center'%>
                <%= content_tag :span, "#{number_to_currency(product.coverage_amount, unit: 'â‚±', precision: 2)}", style: "width: 150px; font-size: .8rem",  class: 'text-center' %>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div> 

  <%= turbo_frame_tag "computation" do %>
    <%= render "group_remits/computation" %>
  <% end %>  
</div>


<div class="table-responsive">
  <%= turbo_frame_tag "batches" do %>
  <table class="table table-hover">
    <thead>
      <tr class="table-dark">

        <th class="text-center" scope="col">ID</th>
        <th class="text-center" scope="col">Members</th>
        <th class="text-center" scope="col">Premium</th>
        <th class="text-center" scope="col">Beneficiaries</th>
        <% if @agreement.plan.gyrt_type == 'family' %>
          <th class="text-center" scope="col">Dependents</th>
        <% end %>
        <th class="text-center" scope="col">Actions</th>

      </tr>
    </thead>

    <tbody id="batches_body">
      <% if @group_remit.batches.exists? %>
        <%= render @batches, group_remit: @group_remit, agreement: @agreement %>
      <% end %>
    </tbody>
  </table>

</div>

<%== pagy_bootstrap_nav(@pagy) %>
<% end %>