<%= turbo_frame_tag "modal-xl" do %>
  <div class="card">
    <div class="card-header">
      <% if @for_modal.present? %>
        <div class="text-end">
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
      <% end %>
      <%= content_tag :h5, 'Coverage of', class: "text-muted" %>
      <%= content_tag :h3, @coop_member.get_fullname, class: "text-primary" %>
    </div>
    <div class="card-body">
      <table class="table table-bordered table-hover align-middle">
        <thead>
          <%# <th>Details</th>
        <th>Effectivity</th>
        <th>Expiry</th>
        <th>Coverage</th> %>
        </thead>
        <tbody>
          <%# @batch.group_by(&:agreement_benefit).each do |agreement_benefit, batch| %>
            <% @batch_gyrt.group_by(&:agreement_benefit).each do |agreement_benefit, batch| %>
              <tr>
                <td colspan=3> <strong><%= agreement_benefit.agreement.plan %></strong> <br>
                  <%= agreement_benefit.name %> <br>
                  <% if current_user.userable_type == "CoopUser" %>
                    <%= link_to 'File Claims', new_coop_process_claims_path(cm: @coop_member, ab: agreement_benefit, a: agreement_benefit.agreement), class: 'btn btn-sm btn-warning' %>
                  <% end %>
                  <%= agreement_benefit.description %>
                </td>
                <td>
                  <table class="table align-middle">
                    <tbody>
                      <%# prod_benefit = ProductBenefit.where(agreement_benefit: agreement_benefit) %>
                      <% prod_benefit = agreement_benefit.get_product_benefits %>
                      <% prod_benefit.each do |pb| %>
                        <tr>
                          <td><small><%= pb.benefit %></small></td>
                          <td class="text-end"><small><%= to_curr(pb.coverage_amount) %></small></td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </td>
              </tr>
              <% batch.each do |b| %>
                <tr>
                  <td>
                    <small>Effectivity</small><br>
                    <%= b.effectivity_date %>
                  </td>
                  <td>
                    <small>Expiry</small><br>
                    <%= b.expiry_date %>
                  </td>
                  <td> <%= b.insurance_status.to_s.humanize %></td>
                  <td> Submitted <%#= to_longdate(b.group_remits.find_by(type: "Remittance").process_coverage.created_at) %> </td>
                </tr>
              <% end %>
            <% end %>
          </tbody>
        </table>
        <%= content_tag :p, "LPPI coverages", class: "lead" %>
        <table class="table table-bordered table-hover align-middle">
          <thead>
            <th>Group Remit</th>
            <th>Terms</th>
            <th>Loan</th>
            <th>Premium</th>
          </thead>
          <tbody>
            <% @batch_lppi.each do |lppi| %>
              <tr>
                <td><%= lppi.group_remit %> <small><%= batch_status(lppi.status) %></small></td>
                <td>
                  <%= "Eff: #{lppi.effectivity_date}" %> <br>
                  <%= "Exp: #{lppi.expiry_date}" %> <br>
                  <%= "Terms: #{lppi.terms}" %>
                </td>
                <td>
                  <%= lppi.loan.name %> - <%= to_currency(lppi.loan_amount) %>
                </td>
                <td><%= to_currency(lppi.premium) %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      <div class="card-footer">
        <% unless @for_modal.present? %>
          <%= link_to "Back", :back, data: { turbo: false }, class: 'btn btn-secondary' %>
        <% end %>
      </div>
    </div>
  <% end %>
