<!-- New Member form Modal -->
<!-- Necessary for both Coop and MIS batch enrollment please don't remove -->
<% if mis_user?(current_user) %>
  <%=  render 'coop_members/member_import_modal' %>
<% elsif current_user.userable_type == "CoopUser" %>
  <%=  render 'member_import_modal' %>
<% end %>
<div class="<%= flex_justify_align('','') %> gap-3">
  <% unless current_user.is_mis? %>
    <%= content_tag :h3, 'Members', class: 'text-primary mb-0'  %>
  <% end %>
  <div class="d-flex gap-1 mb-3">
    <div class="mb-1">
      <%= link_to "Enroll", new_member_path(cooperative_id: @cooperative.id), 
        class: small_btn('outline-primary'), 
        data: {
          turbo_frame: "modal-xl"
        } %>
    </div>
    <!-- Necessary for both Coop and MIS batch enrollment please don't remove  -->
    <div class="mb-1">
      <% if mis_user?(current_user) %>
        <%= render 'coop_members/member_import_btn' %>
      <% elsif current_user.userable_type == "CoopUser" %>
        <%= render 'member_import_btn' %>
      <% end %>
    </div>
    <%  if @cooperative.denied_enrollees.present? %>
      <div class="">
        <%= link_to denied_enrollees_path, class: "#{small_btn('outline-danger')} position-relative" do %>
          Remarks
          <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
            !
            <span class="visually-hidden">unread messages</span>
          </span>
        <% end %>
      </div>
    <% end %>
  </div>
</div>
<div class="d-flex justify-content-between align-items-center mb-3">
  <div class="d-flex align-items-center gap-1 mb-1">
    <%= search_form_for @q, url: mis_user?(current_user) ? cooperative_path(@cooperative.id) : coop_members_path(cooperative_id: @cooperative.id), method: :get do |f| %>
      <div class="form-group d-flex gap-1">
        <%= f.search_field :first_name_or_middle_name_or_last_name_or_email_or_mobile_number_cont, placeholder: "Member Name", class: "form-control" %>
        <%= button_tag(type: 'submit', class: small_btn('warning text-dark'), style: "width: 40px") do %>
          <i class="bi bi-search"></i>
        <% end %>
      </div>
    <% end %>
    <%= link_to current_user.is_mis? ? cooperative_path(@cooperative) : coop_members_path(cooperative_id: @cooperative.id), class: "btn btn-secondary", title: "Reload" do %>
      <i class="bi bi-arrow-clockwise"></i>
    <% end %>
  </div>
  <% if @pagy_members.pages > 1 %>
    <%== pagy_bootstrap_nav(@pagy_members) %>
  <% end %>
</div>
<div class="table table-striped">
  <table class="table table-striped table-bordered table-hover align-middle">
    <thead>
      <tr>
        <th scope="col" >Name</th>
        <th scope="col" >Branch</th>
        <th scope="col" >Actions</th>
      </tr>
    </thead>
    <tbody>
      <td colspan="12" class="text-center">
        <% if @filtered_members.blank? %>
          No members yet.
        <% end %>
      </td>
      <% @filtered_members.each do |member| %>
        <% coop_member = member.coop_members.find_by(cooperative_id: @cooperative.id)%>
        <tr>
          <td>
            <div class="">
              <div class="<%= flex_justify_align('','center') %> gap-2">
                <% if coop_member.deceased? %>
                  <%= content_tag :span, 'DECEASED', class: badge('danger') %>
                <% end %>
              </div>
              <%= content_tag :strong, "#{coop_member.get_fullname}" %> <%= content_tag :small, "#{member.birth_date.strftime('%b %d, %y')}", class: "text-muted" %>
              <div class="d-flex align-items-center gap-1">
                <% if member.mobile_number.present? %>
                  <span class="sm-secondary-text text-muted"><i class="bi bi-phone"></i> <%= member.mobile_number %> </span>
                <% end %>
                <% if member.email.present? %>
                  <span class="sm-secondary-text text-muted"><i class="bi bi-envelope"></i> <%= member.email %> </span>
                <% end %>
              </div>
            </div>
          </td>
          <td><%= coop_member.coop_branch.name.titleize %></td>
          <td>
            <%= link_to '<i class="bi bi-eye-fill"></i>'.html_safe, coop_member, class: small_btn('outline-primary'), data: {turbo_frame: 'modal-xl'}, title: 'Show' %>
            <%= link_to '<i class="bi bi-pencil-square"></i>'.html_safe, edit_member_path(member, cooperative_id: @cooperative.id), class: small_btn('outline-primary'), data: {turbo_frame: 'modal-xl'}, title: 'Edit' %>
            <% if current_user.is_coop_user? and coop_member.with_coverages? %>
              <%= link_to '<i class="bi bi-shield-check"></i>'.html_safe, show_insurance_coop_member_path(coop_member), class: small_btn('outline-primary'), title: 'Coverages' %>
            <% end %>
            <%#  if current_user.is_claims? %>
            <%= link_to '<i class="bi bi-clipboard-pulse"></i>'.html_safe, new_ca_claims_process_claims_path(cm: coop_member), class: small_btn('outline-primary'), title: 'File Claims' if current_user.userable == 'Employee' %>
            <%# end  %>
            <%# end %>
            <%# <% if coop_member.batches.joins(:group_remits).where(group_remits: { type: 'BatchRemit' }).exists? %>
            <%# <%= link_to 'Insurance', member_agreements_coop_member_path(coop_member), class: 'btn btn-sm btn-primary' %>
            <%# <% end %>
            <%# <%= link_to 'Coverage', show_insurance_coop_member_path(coop_member), class: 'btn btn-sm btn-secondary' %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>